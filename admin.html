<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>REBELZ Admin – Update Truck Info</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS for the map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="brand">
        <img
          src="rebelz-logo.png"
          alt="REBELZ Food Truck logo"
          class="logo-img"
        />
        <div>
          <h1>REBELZ Admin</h1>
          <p>Update location, hours, and links, then download a new location.json.</p>
        </div>
      </div>
    </header>

    <main class="main admin-main">
      <section class="card card-info">
        <h2>Location Details</h2>
        <form id="locationForm" class="admin-form">
          <label>
            Display location name (short title)
            <input type="text" id="locationName" placeholder="Downtown, Main &amp; 5th" required />
          </label>

          <label>
            Address (what customers see)
            <input type="text" id="address" placeholder="123 Main St, Springfield, NY" />
          </label>

          <label>
            Latitude (optional – for map pin)
            <input type="number" id="lat" step="any" />
          </label>

          <label>
            Longitude (optional – for map pin)
            <input type="number" id="lng" step="any" />
          </label>

          <label>
            Last updated (text)
            <input
              type="text"
              id="lastUpdated"
              placeholder="2025-11-13 11:45 AM"
              required
            />
          </label>

          <div class="admin-buttons">
            <button type="button" class="btn btn-secondary" id="useNow">
              Use current date &amp; time
            </button>
          </div>

          <hr />

          <h3>Hours / Time Frames</h3>
          <p class="sub">
            You can rename “Lunch / Dinner / Late Night” and set any times you like.
            Only rows with a name or time will show on the public page.
          </p>

          <label>
            Time frame 1 name
            <input type="text" id="scheduleLabel1" placeholder="Lunch" />
          </label>
          <label>
            Time frame 1 hours
            <input type="text" id="scheduleTime1" placeholder="11:30 AM – 2:30 PM" />
          </label>

          <label>
            Time frame 2 name
            <input type="text" id="scheduleLabel2" placeholder="Dinner" />
          </label>
          <label>
            Time frame 2 hours
            <input type="text" id="scheduleTime2" placeholder="5:00 PM – 9:00 PM" />
          </label>

          <label>
            Time frame 3 name
            <input type="text" id="scheduleLabel3" placeholder="Late Night" />
          </label>
          <label>
            Time frame 3 hours
            <input type="text" id="scheduleTime3" placeholder="9:30 PM – 12:00 AM" />
          </label>

          <hr />

          <h3>Links &amp; Contact</h3>
          <label>
            Instagram URL
            <input type="url" id="instagramUrl" placeholder="https://instagram.com/yourtruck" />
          </label>

          <label>
            TikTok URL
            <input type="url" id="tiktokUrl" placeholder="https://tiktok.com/@yourtruck" />
          </label>

          <label>
            Website URL
            <input type="url" id="websiteUrl" placeholder="https://yourtruck.com" />
          </label>

          <label>
            Contact button label
            <input type="text" id="contactLabel" placeholder="Contact" />
          </label>

          <label>
            Contact link (mailto:, tel:, or https://)
            <input type="text" id="contactHref" placeholder="mailto:info@rebelztruck.com" />
          </label>

          <div class="admin-buttons">
            <button type="submit" class="btn">
              Update Preview &amp; JSON
            </button>
          </div>
        </form>

        <p class="sub">
          After updating, click “Download location.json” and upload/replace it
          in your hosting (Netlify, GitHub, etc.).
        </p>
      </section>

      <section class="card card-map">
        <h2>Preview Map</h2>
        <div id="adminMap"></div>
        <p class="sub" id="previewText">Enter a location and click “Update Preview &amp; JSON”.</p>
      </section>

      <section class="card card-json">
        <h2>Generated location.json</h2>
        <pre id="jsonOutput" class="json-output">
{
  "lat": 0,
  "lng": 0,
  "locationName": "",
  "address": "",
  "lastUpdated": "",
  "schedule": [],
  "links": {}
}
        </pre>
        <button id="downloadBtn" class="btn" disabled>
          Download location.json
        </button>
      </section>
    </main>

    <footer class="footer">
      <p>For REBELZ staff only.</p>
    </footer>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Simple front-end password gate
    const ADMIN_PASSWORD = "rebelz2025"; // TODO: change this to your own password

    const entered = prompt("Enter admin password:");
    if (entered !== ADMIN_PASSWORD) {
      document.body.innerHTML =
        "<div style='padding:2rem;font-family:system-ui;color:#e5e7eb;background:#020617;min-height:100vh;display:flex;align-items:center;justify-content:center;'><h1>Access denied.</h1></div>";
      throw new Error("Invalid password");
    }

    // DOM elements
    const locationNameInput = document.getElementById("locationName");
    const addressInput = document.getElementById("address");
    const latInput = document.getElementById("lat");
    const lngInput = document.getElementById("lng");
    const lastUpdatedInput = document.getElementById("lastUpdated");
    const useNowBtn = document.getElementById("useNow");

    const scheduleLabel1 = document.getElementById("scheduleLabel1");
    const scheduleTime1 = document.getElementById("scheduleTime1");
    const scheduleLabel2 = document.getElementById("scheduleLabel2");
    const scheduleTime2 = document.getElementById("scheduleTime2");
    const scheduleLabel3 = document.getElementById("scheduleLabel3");
    const scheduleTime3 = document.getElementById("scheduleTime3");

    const instagramUrlInput = document.getElementById("instagramUrl");
    const tiktokUrlInput = document.getElementById("tiktokUrl");
    const websiteUrlInput = document.getElementById("websiteUrl");
    const contactLabelInput = document.getElementById("contactLabel");
    const contactHrefInput = document.getElementById("contactHref");

    const form = document.getElementById("locationForm");
    const jsonOutput = document.getElementById("jsonOutput");
    const downloadBtn = document.getElementById("downloadBtn");
    const previewText = document.getElementById("previewText");
    const adminMapEl = document.getElementById("adminMap");

    // Default map center
    const DEFAULT_LAT = 40.7128;
    const DEFAULT_LNG = -74.0060;
    const DEFAULT_ZOOM = 13;

    let map = L.map(adminMapEl).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);
    let marker = L.marker([DEFAULT_LAT, DEFAULT_LNG]).addTo(map);

    function formatNow() {
      const now = new Date();
      const options = {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "numeric",
        minute: "2-digit",
      };
      return now.toLocaleString(undefined, options);
    }

    useNowBtn.addEventListener("click", () => {
      lastUpdatedInput.value = formatNow();
    });

    function populateFromData(data) {
      if (!data || typeof data !== "object") return;

      locationNameInput.value = data.locationName || "";
      addressInput.value = data.address || "";
      if (typeof data.lat === "number") latInput.value = data.lat;
      if (typeof data.lng === "number") lngInput.value = data.lng;
      lastUpdatedInput.value = data.lastUpdated || "";

      const schedule = data.schedule || [];
      if (schedule[0]) {
        scheduleLabel1.value = schedule[0].label || "";
        scheduleTime1.value = schedule[0].time || "";
      }
      if (schedule[1]) {
        scheduleLabel2.value = schedule[1].label || "";
        scheduleTime2.value = schedule[1].time || "";
      }
      if (schedule[2]) {
        scheduleLabel3.value = schedule[2].label || "";
        scheduleTime3.value = schedule[2].time || "";
      }

      const links = data.links || {};
      instagramUrlInput.value = links.instagram || "";
      tiktokUrlInput.value = links.tiktok || "";
      websiteUrlInput.value = links.website || "";
      contactLabelInput.value = links.contactLabel || "";
      contactHrefInput.value = links.contactHref || "";
    }

    async function loadExistingConfig() {
      try {
        const res = await fetch("location.json?cacheBust=" + Date.now());
        if (!res.ok) return;
        const data = await res.json();
        populateFromData(data);

        // Also update preview + JSON
        buildAndRenderJSON();
      } catch (e) {
        console.warn("Could not load existing location.json:", e);
      }
    }

    function buildAndRenderJSON() {
      const latVal = latInput.value.trim();
      const lngVal = lngInput.value.trim();
      const lat = latVal === "" ? null : parseFloat(latVal);
      const lng = lngVal === "" ? null : parseFloat(lngVal);

      const locationName = locationNameInput.value.trim();
      const address = addressInput.value.trim();
      const lastUpdated = lastUpdatedInput.value.trim();

      if (!locationName || !lastUpdated) {
        alert("Please fill in at least a location name and last updated time.");
        return null;
      }

      const schedule = [
        { label: scheduleLabel1.value.trim(), time: scheduleTime1.value.trim() },
        { label: scheduleLabel2.value.trim(), time: scheduleTime2.value.trim() },
        { label: scheduleLabel3.value.trim(), time: scheduleTime3.value.trim() },
      ].filter((item) => item.label || item.time);

      const links = {
        instagram: instagramUrlInput.value.trim(),
        tiktok: tiktokUrlInput.value.trim(),
        website: websiteUrlInput.value.trim(),
        contactLabel: contactLabelInput.value.trim(),
        contactHref: contactHrefInput.value.trim(),
      };

      const data = {
        lat: typeof lat === "number" && !Number.isNaN(lat) ? lat : null,
        lng: typeof lng === "number" && !Number.isNaN(lng) ? lng : null,
        locationName,
        address,
        lastUpdated,
        schedule,
        links,
      };

      const json = JSON.stringify(data, null, 2);
      jsonOutput.textContent = json;
      downloadBtn.disabled = false;

      // Map preview
      if (data.lat !== null && data.lng !== null) {
        marker.setLatLng([data.lat, data.lng]);
        map.setView([data.lat, data.lng], DEFAULT_ZOOM);
        previewText.textContent = `Preview: ${locationName} — map set to coordinates.`;
      } else {
        marker.setLatLng([DEFAULT_LAT, DEFAULT_LNG]);
        map.setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);
        previewText.textContent = address
          ? `Preview: ${locationName} — ${address} (no coordinates set, map shows default city).`
          : `Preview: ${locationName} (no coordinates set, map shows default city).`;
      }

      return data;
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      buildAndRenderJSON();
    });

    downloadBtn.addEventListener("click", () => {
      const json = jsonOutput.textContent.trim();
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "location.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Load existing config if available
    loadExistingConfig();
  </script>
</body>
</html>
